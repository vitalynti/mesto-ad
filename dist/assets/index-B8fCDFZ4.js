(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const s of c.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function o(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(r){if(r.ep)return;r.ep=!0;const c=o(r);fetch(r.href,c)}})();const i={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"cc9772ee-528c-4832-8db2-1d255ee4518d","Content-Type":"application/json"}},d=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),Y=()=>fetch(`${i.baseUrl}/users/me`,{headers:i.headers}).then(d),D=()=>fetch(`${i.baseUrl}/cards`,{headers:i.headers}).then(d),Z=({name:e,about:t})=>fetch(`${i.baseUrl}/users/me`,{method:"PATCH",headers:i.headers,body:JSON.stringify({name:e,about:t})}).then(d),ee=e=>fetch(`${i.baseUrl}/users/me/avatar`,{method:"PATCH",headers:i.headers,body:JSON.stringify({avatar:e})}).then(d),te=({name:e,link:t})=>fetch(`${i.baseUrl}/cards`,{method:"POST",headers:i.headers,body:JSON.stringify({name:e,link:t})}).then(d),oe=(e,t)=>fetch(`${i.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:i.headers}).then(d),ne=e=>fetch(`${i.baseUrl}/cards/${e}`,{method:"DELETE",headers:i.headers}).then(d),re=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),N=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:n,onInfoClick:r,userId:c})=>{const s=re(),l=s.querySelector(".card__like-count"),a=s.querySelector(".card__like-button"),b=s.querySelector(".card__control-button_type_delete"),T=s.querySelector(".card__control-button_type_info"),q=s.querySelector(".card__image"),X=s.querySelector(".card__title");return l.textContent=e.likes.length,q.src=e.link,q.alt=e.name,X.textContent=e.name,e.likes.some(g=>g._id===c)&&a.classList.add("card__like-button_is-active"),e.owner._id!==c?b&&b.remove():b.addEventListener("click",()=>{n(e._id,s)}),o&&a.addEventListener("click",()=>{o(a,e._id)}),t&&q.addEventListener("click",()=>{t({name:e.name,link:e.link})}),T?r?T.addEventListener("click",g=>{g.stopPropagation(),console.log("Клик по 'i' сработал! ID карточки:",e._id),r(e._id)}):console.warn("Функция onInfoClick не передана в createCardElement"):console.error("Кнопка .card__control-button_type_info не найдена в шаблоне!"),s},O=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");u(t)}},_=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",O)},u=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",O)},V=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{u(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&u(e)})};function ce(e,t,o,n){const r=e.querySelector(`#${t.id}-error`);t.classList.add(n.inputErrorClass),r.textContent=o,r.classList.add(n.errorClass)}function W(e,t,o){const n=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),n.textContent="",n.classList.remove(o.errorClass)}function se(e,t,o){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?W(e,t,o):ce(e,t,t.validationMessage,o)}function le(e){return e.some(t=>!t.validity.valid)}function H(e,t){e.classList.add(t.inactiveButtonClass),e.disabled=!0}function ie(e,t){e.classList.remove(t.inactiveButtonClass),e.disabled=!1}function U(e,t,o){le(e)?H(t,o):ie(t,o)}function ae(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);U(o,n,t),o.forEach(r=>{r.addEventListener("input",()=>{se(e,r,t),U(o,n,t)})})}function ue(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);o.forEach(r=>{W(e,r,t),r.setCustomValidity("")}),H(n,t)}function de(e){Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{ae(o,e)})}const j=document.querySelector(".places__list"),k=document.querySelector(".popup_type_edit"),E=k.querySelector(".popup__form"),J=E.querySelector(".popup__input_type_name"),z=E.querySelector(".popup__input_type_description"),I=document.querySelector(".popup_type_new-card"),p=I.querySelector(".popup__form"),pe=p.querySelector(".popup__input_type_card-name"),me=p.querySelector(".popup__input_type_url"),x=document.querySelector(".popup_type_image"),$=x.querySelector(".popup__image"),_e=x.querySelector(".popup__caption"),fe=document.querySelector(".profile__edit-button"),ye=document.querySelector(".profile__add-button"),w=document.querySelector(".profile__title"),B=document.querySelector(".profile__description"),M=document.querySelector(".profile__image"),P=document.querySelector(".popup_type_edit-avatar"),L=P.querySelector(".popup__form"),he=L.querySelector(".popup__input"),y=document.querySelector(".popup_type_info"),f=y.querySelector(".popup__info"),A=y.querySelector(".popup__list"),h=document.querySelector(".popup_type_remove-card"),Se=h.querySelector(".popup__form"),S=(e,t)=>{const n=document.querySelector("#popup-info-definition-template").content.querySelector(".popup__info-item").cloneNode(!0);return n.querySelector(".popup__info-term").textContent=e,n.querySelector(".popup__info-description").textContent=t,n},ve=()=>{D().then(e=>{f.innerHTML="",A.innerHTML="",y.querySelector(".popup__title").textContent="Статистика карточек",y.querySelector(".popup__text").textContent="Популярные карточки:";const t=new Set;e.forEach(l=>{t.add(l.owner._id)});const o=e.reduce((l,a)=>l+a.likes.length,0),n=Math.max(...e.map(l=>l.likes.length)),r=e.reduce((l,a)=>a.likes.length>l.likes.length?a:l),c=[...e].sort((l,a)=>a.likes.length-l.likes.length).slice(0,3);f.append(S("Всего пользователей:",t.size.toString())),f.append(S("Всего лайков:",o.toString())),f.append(S("Максимально лайков от одного:",n.toString())),f.append(S("Чемпион лайков:",r.owner.name));const s=document.querySelector("#popup-info-user-preview-template").content;c.forEach(l=>{const a=s.querySelector(".popup__list-item").cloneNode(!0);a.textContent=l.name,A.append(a)}),_(y)}).catch(e=>{console.log("Ошибка при загрузке статистики:",e)})};function m(e,t,o="Сохранить",n="Сохранение..."){e?t.textContent=n:t.textContent=o}const K={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},R=({name:e,link:t})=>{$.src=t,$.alt=e,_e.textContent=e,_(x)},Ce=e=>{e.preventDefault();const t=e.submitter;m(!0,t),ee(he.value).then(o=>{M.style.backgroundImage=`url(${o.avatar})`,u(P),L.reset()}).catch(o=>console.log(o)).finally(()=>{m(!1,t)})},Le=e=>{e.preventDefault();const t=e.submitter;m(!0,t),Z({name:J.value,about:z.value}).then(o=>{w.textContent=o.name,B.textContent=o.about,u(k)}).catch(o=>console.log(o)).finally(()=>{m(!1,t)})},be=e=>{e.preventDefault();const t=e.submitter;m(!0,t,"Создать","Создание..."),te({name:pe.value,link:me.value}).then(o=>{const n=N(o,{onPreviewPicture:R,onLikeIcon:Q,onDeleteCard:G,userId:window.currentUserId});j.prepend(n),u(I),p.reset(),ue(p,K)}).catch(o=>console.log(o)).finally(()=>{m(!1,t,"Создать")})};E.addEventListener("submit",Le);p.addEventListener("submit",be);L.addEventListener("submit",Ce);fe.addEventListener("click",()=>{J.value=w.textContent,z.value=B.textContent,_(k)});M.addEventListener("click",()=>{L.reset(),_(P)});ye.addEventListener("click",()=>{p.reset(),_(I)});const qe=document.querySelectorAll(".popup");qe.forEach(e=>{V(e)});V(h);de(K);Promise.all([D(),Y()]).then(([e,t])=>{window.currentUserId=t._id,w.textContent=t.name,B.textContent=t.about,M.style.backgroundImage=`url('${t.avatar}')`,e.forEach(o=>{const n=N(o,{onPreviewPicture:R,onLikeIcon:Q,onDeleteCard:G,userId:window.currentUserId});j.append(n)}),console.log("Данные успешно загружены с сервера")}).catch(e=>{console.error(`Ошибка при загрузке данных: ${e}`)});let v=null,C=null;const G=(e,t)=>{v=e,C=t,_(h)},ge=e=>{if(e.preventDefault(),v&&C){const t=e.submitter,o=t.textContent;t.textContent="Удаление...",ne(v).then(()=>{C.remove(),u(h),v=null,C=null}).catch(n=>{console.log("Ошибка при удалении карточки:",n),u(h)}).finally(()=>{t.textContent=o})}};Se.addEventListener("submit",ge);const Q=(e,t)=>{const o=e.classList.contains("card__like-button_is-active");oe(t,o).then(n=>{e.classList.toggle("card__like-button_is-active");const c=e.closest(".card").querySelector(".card__like-count");c.textContent=n.likes.length}).catch(n=>{console.log("Ошибка при обновлении лайка:",n)})},F=document.querySelector(".header__logo");F?(F.addEventListener("click",ve),console.log("Обработчик добавлен на логотип")):console.log("Логотип не найден! Проверьте HTML");
